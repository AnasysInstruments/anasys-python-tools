# -*- encoding: utf-8 -*-
#
#  anasysdoc.py
#
#  Copyright 2017 Cody Schindler <cschindler@anasysinstruments.com>
#
#  This program is the property of Anasys Instruments, and may not be
#  redistributed or modified without explict permission of the author.

import xml.etree.ElementTree as ET
# from . import anasysfile
# from . import heightmap
# from . import irspectra
import anasysfile
import heightmap
import irspectra

class AnasysDoc(anasysfile.AnasysElement):
    """Object for holding document data in a file generated by Analysis Studio"""
    def __init__(self, ftree):
        self._skip_on_write = []
        self._special_write = {'Backgrounds': self._write_backgrounds,
                               'HeightMaps': self._write_height_maps,
                               'RenderedSpectra':self._write_rendered_spectra,
                               'SpectraChannelViews': self._write_spectral_channel_views}
        self._special_read = {'HeightMaps': self._read_height_maps,
                              'RenderedSpectra':self._read_rendered_spectra,
                              'Backgrounds': self._read_backgrounds,
                              'SpectraChannelViews': self._read_spectral_channel_views}
        anasysfile.AnasysElement.__init__(self, etree=ftree)

    def _read_rendered_spectra(self, spectra):
        spectradict = {}
        for spectrum in spectra:
            sp = irspectra.IRRenderedSpectra(spectrum)
            key = sp.Label
            key = self._check_key(key, spectradict)
            spectradict[key] = sp
        return spectradict

    def _read_height_maps(self, maps):
        """Takes an iterable of Height Maps, and returns a dict of HeightMap objects"""
        mapdict = {}
        for _map in maps:
            # self._attr_to_children(_map)
            new_map = heightmap.HeightMap(_map)
            key = new_map.Label
            key = self._check_key(key, mapdict)
            mapdict[key] = new_map
        return mapdict

    def _read_spectral_channel_views(self, scvs):
        """Takes an iterable of IRSpectraChannelViews, and returns a dict of IRSpectraChannelViews objects"""
        newdict = {}
        for item in scvs:
            new_item = anasysfile.AnasysElement(etree=item)
            key = item.find('Label').text
            key = self._check_key(key, newdict)
            newdict[key] = new_item
        return newdict

    def _read_backgrounds(self, backgrounds):
        """Returns a list of the Background objects"""
        bgdict = {}
        for bg in backgrounds:
            new_bg = irspectra.Background(bg)
            key = new_bg.ID
            key = self._check_key(key, bgdict)
            bgdict[key] = new_bg
        return bgdict

    def _write_backgrounds(self, elem, nom, bgs):
        new_elem = ET.Element(nom)
        for bg in self.Backgrounds.values():
            rr = bg._anasys_to_etree(bg, name="Background")
            new_elem.append(rr)
        elem.append(new_elem)

    def _write_rendered_spectra(self, elem, nom, spectrums):
        new_elem = ET.Element(nom)
        for spectra in spectrums.values():
            rr = spectra._anasys_to_etree(spectra, name="IRRenderedSpectra")
            new_elem.append(rr)
        elem.append(new_elem)

    def _write_height_maps(self, elem, nom, heightmaps):
        new_elem = ET.Element(nom)
        for hm in heightmaps.values():
            rr = hm._anasys_to_etree(hm, name="HeightMap")
            new_elem.append(rr)
        elem.append(new_elem)

    def _write_spectral_channel_views(self, elem, nom, scvs):
        new_elem = ET.Element(nom)
        for item in scvs.values():
            rr = item._anasys_to_etree(item, name="IRSpectraChannelView")
            new_elem.append(rr)
        elem.append(new_elem)
